<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finan√ßas Pro - v3.4</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
    <header>
        <h1>Finan√ßas <span>H1a.17</span></h1>
        <button class="btn" style="background:#1e293b; color:white" onclick="toggleConfig()">‚öôÔ∏è Cronograma</button>
    </header>

    <div id="configPanel" class="config-panel">
        <h3 style="margin-top:0">Ajustar Valores (R$)</h3>
        <div id="configRows"></div>
        <button class="btn" style="background:#10b981; color:white; margin-top:10px" onclick="salvarConfig()">üíæ Salvar</button>
    </div>

    <div class="stats">
        <div class="card" style="border-top:4px solid #3b82f6"><small>D√≠vida</small><div id="res-saldo">R$ 0,00</div></div>
        <div class="card" style="border-top:4px solid #10b981"><small>Econ. IPCA</small><div id="res-ipca">R$ 0,00</div></div>
        <div class="card" style="border-top:4px solid #f59e0b"><small>Econ. Amort.</small><div id="res-amort">R$ 0,00</div></div>
        <div class="card" style="border-top:4px solid #1e293b"><small>Restantes</small><div id="res-rest">0</div></div>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr><th>N¬∫</th><th>Vencimento</th><th>Valor Base</th><th>Data Pagto</th><th>Amort. Extra</th><th>Pago?</th><th>Custo Real</th><th>Status</th><th>Saldo</th></tr>
            </thead>
            <tbody id="tabela-corpo"></tbody>
        </table>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://rcntxxttlwcvcbiexgkk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjbnR4eHR0bHdjdmNiaWV4Z2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MjMyMzksImV4cCI6MjA4NTA5OTIzOX0.dapH3LiZSft8P_i7nyVE4gIdNl5EgAglaZqfK_tbjGU';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let dadosNuvem = {}; let configParcelas = [];
    const SALDO_INICIAL = 138264.72;

    function fMoeda(v) { return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    
    function parseMoeda(v) {
        if (!v || v === "") return 0;
        let limpo = v.toString().replace(/[R$\s]/g, '').replace(/\./g, '').replace(',', '.');
        return parseFloat(limpo) || 0;
    }

    async function carregarTudo() {
        const { data: cfg } = await supabaseClient.from('config_parcelas').select('*').order('de_parcela');
        if (cfg) { configParcelas = cfg; renderizarConfig(); }
        const { data: p } = await supabaseClient.from('parcelas_lote').select('*');
        if (p) {
            p.forEach(item => { dadosNuvem[`p_${item.id}`] = { data: item.data_pagto, amort: item.amort_extra, pago: item.pago }; });
            renderizar();
        }
    }

    function getValorBase(n) {
        const c = configParcelas.find(x => n >= x.de_parcela && n <= x.ate_parcela);
        return c ? parseFloat(c.valor_base) : 1315.16;
    }

    async function salvarParcela(i) {
        const d = document.getElementById(`date_${i}`).value;
        const a = parseMoeda(document.getElementById(`amort_${i}`).value);
        const p = document.getElementById(`check_${i}`).checked;
        await supabaseClient.from('parcelas_lote').upsert({ id: i, data_pagto: d, amort_extra: a, pago: p });
        carregarTudo();
    }

    function renderizar() {
        const corpo = document.getElementById('tabela-corpo'); corpo.innerHTML = '';
        let saldo = SALDO_INICIAL; let econIPCA = 0; let econAmort = 0; let pagas = 0;
        let poolAmort = [];

        for (let i = 1; i <= 180; i++) {
            let d = dadosNuvem[`p_${i}`] || { data: "", amort: 0, pago: false };
            if (d.pago) { pagas++; if (d.amort > 0) poolAmort.push({ valor: d.amort, origem: i }); }
        }

        let quitadasFim = [];
        poolAmort.forEach(item => {
            let sobra = item.valor;
            for (let j = 180; j >= 1; j--) {
                let custoJ = getValorBase(j);
                if (!quitadasFim[j] && !dadosNuvem[`p_${j}`]?.pago && sobra >= custoJ) {
                    econAmort += custoJ; quitadasFim[j] = { por: item.origem }; sobra -= custoJ;
                }
            }
        });

        for (let i = 1; i <= 180; i++) {
            const vcto = new Date(2024, 10, 25); vcto.setMonth(vcto.getMonth() + (i-1));
            let d = dadosNuvem[`p_${i}`] || { data: "", amort: 0, pago: false };
            let amortizada = quitadasFim[i];
            let juros = (i >= 16 && !amortizada && !d.pago) ? saldo * 0.0028 : 0;
            let custoReal = getValorBase(i);
            
            if (d.pago) {
                if (new Date(d.data + "T00:00:00") <= vcto || i < 16) { econIPCA += (saldo * 0.0028); juros = 0; }
                else { custoReal += (saldo * 0.0028); }
            }

            let saida = d.pago ? (getValorBase(i) + d.amort) : 0;
            if (amortizada) { saida = 0; custoReal = 0; }
            saldo = (saldo + juros) - saida; if (saldo < 0) saldo = 0;

            const tr = document.createElement('tr');
            if (d.pago) tr.className = 'pago'; if (amortizada) tr.className = 'amortizada';
            tr.innerHTML = `
                <td>${i}</td><td>${vcto.toLocaleDateString('pt-BR')}</td><td>${fMoeda(getValorBase(i))}</td>
                <td><input type="date" id="date_${i}" value="${d.data}" onchange="salvarParcela(${i})"></td>
                <td><input type="text" class="money" id="amort_${i}" value="${d.amort.toLocaleString('pt-BR',{minimumFractionDigits:2})}" onblur="salvarParcela(${i})"></td>
                <td><input type="checkbox" id="check_${i}" ${d.pago ? 'checked' : ''} onchange="salvarParcela(${i})"></td>
                <td>${fMoeda(custoReal)}</td><td>${amortizada ? 'AMORT. P'+amortizada.por : (d.pago ? 'PAGO' : '-')}</td>
                <td><b>${fMoeda(saldo)}</b></td>`;
            corpo.appendChild(tr);
        }
        document.getElementById('res-saldo').innerText = fMoeda(saldo);
        document.getElementById('res-ipca').innerText = fMoeda(econIPCA);
        document.getElementById('res-amort').innerText = fMoeda(econAmort);
        document.getElementById('res-rest').innerText = 180 - pagas - Object.keys(quitadasFim).length;
    }

    function renderizarConfig() {
        const container = document.getElementById('configRows');
        container.innerHTML = configParcelas.map((c, idx) => `
            <div style="margin-bottom:5px">De: ${c.de_parcela} At√©: ${c.ate_parcela} Valor: ${c.valor_base}</div>`).join('');
    }

    function toggleConfig() { const p = document.getElementById('configPanel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    carregarTudo();
</script>
</body>
</html>