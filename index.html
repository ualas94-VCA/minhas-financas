<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finan√ßas Pro - v3.5 Dark Mode</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
    <header>
        <div style="display:flex; align-items:center; gap:20px">
            <h1>Minhas <span>Finan√ßas</span></h1>
            <nav style="display:flex; gap:10px">
                <button id="btn-lote" class="btn btn-primary" onclick="trocarAba('lote')">üè† Loteamento</button>
                <button id="btn-btc" class="btn" style="background:#f7931a; color:white; opacity:0.6" onclick="trocarAba('btc')">‚Çø Bitcoin</button>
            </nav>
        </div>
        <div style="display:flex; gap:10px">
            <button class="btn" style="background:#64748b; color:white" onclick="toggleDark()">üåì Modo Dark</button>
            <button class="btn" style="background:#1e293b; color:white" onclick="toggleConfig()">‚öôÔ∏è</button>
        </div>
    </header>

    <div id="aba-lote">
        <div id="configPanel" class="config-panel">
            <h3 style="margin-top:0">Ajustar Valores Base (R$)</h3>
            <div id="configRows"></div>
            <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button class="btn" style="background:#64748b; color:white" onclick="adicionarLinhaConfig()">Ôºã Novo Intervalo</button>
                <button class="btn" style="background:#10b981; color:white" onclick="salvarConfig()">üíæ Salvar Cronograma</button>
            </div>
        </div>

        <div class="stats">
            <div class="card" style="border-top: 4px solid #3b82f6"><small>D√≠vida Lote</small><div id="res-saldo">R$ 0,00</div></div>
            <div class="card" style="border-top: 4px solid #10b981"><small>Econ. IPCA</small><div id="res-ipca">R$ 0,00</div></div>
            <div class="card" style="border-top: 4px solid #f59e0b"><small>Econ. Amort.</small><div id="res-amort">R$ 0,00</div></div>
            <div class="card" style="border-top: 4px solid #1e293b"><small>Restantes</small><div id="res-rest">0</div></div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>N¬∫</th><th>Vencimento</th><th>Valor Base</th><th>Data Pagto</th><th>Amort. Extra</th><th>Pago?</th><th>Custo Real</th><th>Status</th><th>Saldo</th>
                    </tr>
                </thead>
                <tbody id="tabela-corpo"></tbody>
            </table>
        </div>
    </div>

    <div id="aba-btc" style="display:none">
        <div class="stats">
            <div class="card" style="border-top: 4px solid #f7931a"><small>Pre√ßo BTC (BRL)</small><div id="btc-preco">Carregando...</div></div>
            <div class="card" style="border-top: 4px solid #f7931a"><small>Meu Saldo</small><div id="btc-meu-saldo">‚Çø 0,00</div></div>
            <div class="card" style="border-top: 4px solid #f7931a"><small>Total em Reais</small><div id="btc-total-brl">R$ 0,00</div></div>
        </div>
        <div class="card" style="padding:40px">
            <h3>Em breve: Gest√£o de Carteira Bitcoin</h3>
            <p>Aqui vamos listar suas compras e calcular o seu pre√ßo m√©dio.</p>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://rcntxxttlwcvcbiexgkk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjbnR4eHR0bHdjdmNiaWV4Z2trIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1MjMyMzksImV4cCI6MjA4NTA5OTIzOX0.dapH3LiZSft8P_i7nyVE4gIdNl5EgAglaZqfK_tbjGU';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let dadosNuvem = {}; let configParcelas = [];
    const SALDO_INICIAL = 138264.72;
    const IPCA_MENSAL = 0.0028;
    const DATA_BASE = new Date(2024, 10, 25);

    function toggleDark() { document.body.classList.toggle('dark'); }
    function toggleConfig() { 
        const p = document.getElementById('configPanel'); 
        p.style.display = p.style.display === 'block' ? 'none' : 'block'; 
    }

    function fMoeda(v) { return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    
    function parseMoeda(v) {
        if (!v || v === "") return 0;
        let limpo = v.toString().replace(/[R$\s]/g, '').replace(/\./g, '').replace(',', '.');
        return parseFloat(limpo) || 0;
    }

    async function carregarTudo() {
        const { data: cfg } = await supabaseClient.from('config_parcelas').select('*').order('de_parcela');
        if (cfg) { configParcelas = cfg; renderizarConfig(); }
        const { data: p } = await supabaseClient.from('parcelas_lote').select('*');
        if (p) {
            p.forEach(item => { dadosNuvem[`p_${item.id}`] = { data: item.data_pagto, amort: item.amort_extra, pago: item.pago }; });
            renderizar();
        }
    }

    function formatarParaInput(valor) {
        return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function renderizarConfig() {
        const container = document.getElementById('configRows');
        container.innerHTML = configParcelas.map((c, idx) => `
            <div class="config-row">
                De: <input type="number" style="width:65px" value="${c.de_parcela}" onchange="updateConfig(${idx},'de_parcela',this.value)">
                At√©: <input type="number" style="width:65px" value="${c.ate_parcela}" onchange="updateConfig(${idx},'ate_parcela',this.value)">
                Valor R$: <input type="text" style="width:110px" class="money" value="${formatarParaInput(c.valor_base)}" onblur="updateConfig(${idx},'valor_base',this.value)">
                <button onclick="removerLinha(${idx})" style="color:#ef4444; background:none; border:none; cursor:pointer; font-weight:bold">‚úñ</button>
            </div>`).join('');
    }

    function updateConfig(i, f, v) { 
        // Se for o campo de valor, usa o parseMoeda para entender a v√≠rgula brasileira
        if (f === 'valor_base') {
            configParcelas[i][f] = parseMoeda(v);
        } else {
            configParcelas[i][f] = parseInt(v); 
        }
    }

    function adicionarLinhaConfig() {
        const last = configParcelas.length > 0 ? configParcelas[configParcelas.length-1].ate_parcela : 0;
        configParcelas.push({ de_parcela: last + 1, ate_parcela: 180, valor_base: 1315.16 });
        renderizarConfig();
    }

    async function removerLinha(idx) {
        if(confirm("Remover este intervalo?")) {
            if (configParcelas[idx].id) await supabaseClient.from('config_parcelas').delete().eq('id', configParcelas[idx].id);
            configParcelas.splice(idx, 1);
            renderizarConfig();
            renderizar();
        }
    }

    async function salvarConfig() {
        for (const item of configParcelas) {
            const obj = { de_parcela: item.de_parcela, ate_parcela: item.ate_parcela, valor_base: item.valor_base };
            item.id ? await supabaseClient.from('config_parcelas').update(obj).eq('id', item.id) : await supabaseClient.from('config_parcelas').insert(obj);
        }
        alert("Configura√ß√µes salvas!");
        carregarTudo();
    }

    function getValorBase(n) {
        const c = configParcelas.find(x => n >= x.de_parcela && n <= x.ate_parcela);
        return c ? parseFloat(c.valor_base) : 1315.16;
    }

    async function salvarParcela(i) {
        const d = document.getElementById(`date_${i}`).value;
        const a = parseMoeda(document.getElementById(`amort_${i}`).value);
        const p = document.getElementById(`check_${i}`).checked;
        await supabaseClient.from('parcelas_lote').upsert({ id: i, data_pagto: d, amort_extra: a, pago: p });
        carregarTudo();
    }

   function renderizar() {
        const corpo = document.getElementById('tabela-corpo');
        corpo.innerHTML = '';
        let saldoExibicao = SALDO_INICIAL; 
        let econIPCA = 0; 
        let econAmort = 0; 
        let pagas = 0;
        let poolAmort = [];

        // 1. Identificar pagamentos e coletar valores para o pool de amortiza√ß√£o
        for (let i = 1; i <= 180; i++) {
            let d = dadosNuvem[`p_${i}`] || { data: "", amort: 0, pago: false };
            if (d.pago) { 
                pagas++; 
                if (d.amort > 0) poolAmort.push({ valor: d.amort, origem: i }); 
            }
        }

        // 2. L√≥gica de Abatimento Autom√°tico (Amortiza√ß√£o do final para o in√≠cio)
        let quitadasFim = [];
        poolAmort.forEach(item => {
            let sobra = item.valor;
            for (let j = 180; j >= 1; j--) {
                let custoJ = getValorBase(j);
                if (!quitadasFim[j] && !dadosNuvem[`p_${j}`]?.pago && sobra >= custoJ) {
                    econAmort += custoJ;
                    quitadasFim[j] = { por: item.origem };
                    sobra -= custoJ;
                }
            }
        });

        // 3. Gerar as 180 linhas com a Regra de Desconto de 10%
        for (let i = 1; i <= 180; i++) {
            const vcto = new Date(DATA_BASE); 
            vcto.setMonth(vcto.getMonth() + (i-1));
            
            let d = dadosNuvem[`p_${i}`] || { data: "", amort: 0, pago: false };
            let amortizada = quitadasFim[i];
            
            let valorBaseOriginal = getValorBase(i);
            let valorComDesconto = valorBaseOriginal * 0.90; // Regra de pontualidade
            let custoReal = valorBaseOriginal;

            if (d.pago) {
                let dp = new Date(d.data + "T00:00:00");
                
                // Se pagou em dia (ou parcelas fixas 1-15), aplica 10% de desconto
                if (dp <= vcto || i < 16) { 
                    custoReal = valorComDesconto;
                    econIPCA += (saldoExibicao * IPCA_MENSAL); 
                } else { 
                    custoReal = valorBaseOriginal + (saldoExibicao * IPCA_MENSAL); 
                }
                // Abate o valor principal da d√≠vida
                saldoExibicao -= valorBaseOriginal;
            } else if (amortizada) {
                saldoExibicao -= valorBaseOriginal;
                custoReal = 0;
            }

            const tr = document.createElement('tr');
            if (d.pago) tr.className = 'pago';
            if (amortizada) tr.className = 'amortizada';

            tr.innerHTML = `
                <td>${i}</td>
                <td>${vcto.toLocaleDateString('pt-BR')}</td>
                <td>${fMoeda(valorBaseOriginal)}</td>
                <td><input type="date" id="date_${i}" value="${d.data}" onchange="salvarParcela(${i})"></td>
                <td><input type="text" class="money" id="amort_${i}" value="${d.amort.toLocaleString('pt-BR',{minimumFractionDigits:2})}" onblur="salvarParcela(${i})"></td>
                <td><input type="checkbox" id="check_${i}" ${d.pago ? 'checked' : ''} onchange="salvarParcela(${i})"></td>
                <td>${fMoeda(custoReal)}</td>
                <td>${amortizada ? 'AMORT. P'+amortizada.por : (d.pago ? 'PAGO' : '-')}</td>
                <td><b>${fMoeda(saldoExibicao < 0 ? 0 : saldoExibicao)}</b></td>
            `;
            corpo.appendChild(tr);
        }

        // 4. Atualizar os Cards de Resumo
        document.getElementById('res-saldo').innerText = fMoeda(saldoExibicao < 0 ? 0 : saldoExibicao);
        document.getElementById('res-ipca').innerText = fMoeda(econIPCA);
        document.getElementById('res-amort').innerText = fMoeda(econAmort);
        document.getElementById('res-rest').innerText = 180 - pagas - Object.keys(quitadasFim).length;
        
    }
     async function carregarTudo() {
        // 1. Busca as configura√ß√µes de valores base
        const { data: cfg } = await supabaseClient.from('config_parcelas').select('*').order('de_parcela');
        if (cfg) { 
            configParcelas = cfg; 
            renderizarConfig(); 
        }
        
        // 2. Busca os pagamentos e amortiza√ß√µes
        const { data: p } = await supabaseClient.from('parcelas_lote').select('*');
        if (p) {
            dadosNuvem = {}; 
            p.forEach(item => { 
                dadosNuvem[`p_${item.id}`] = { 
                    data: item.data_pagto, 
                    amort: item.amort_extra, 
                    pago: item.pago 
                }; 
            });
            renderizar(); 
        }
    }

    // Chamada inicial para o sistema rodar ao abrir
    carregarTudo();
</script>
</body>
</html>